<%- diversity_data('giscus', theme.giscus, {
	js : 'https://giscus.app/client.js'
}) %>

<script>
    const loadGiscus = () => {
        const loadingElement = document.getElementById('loading-giscus');
        // 配色方案刷新，重新加载评论
        // 加载提示被隐藏，需要再次显示
        loadingElement.classList.remove('hidden');

        let lang;
        // 加载评论模块
        Diversity.utils.loadComments('.giscus-wrap')
            .then(() => {
                lang = conf.giscus.lang;
                if (!lang)
                    lang = window.navigator.language;
            })
            .then(() => Diversity.utils.getScript(conf.giscus.js, {
                attributes: {
                    async                   : true,
                    crossOrigin             : 'anonymous',
                    'data-repo'             : conf.giscus.repo,
                    'data-repo-id'          : conf.giscus.repo_id,
                    'data-category'         : conf.giscus.category,
                    'data-category-id'      : conf.giscus.category_id,
                    'data-mapping'          : conf.giscus.mapping,
                    'data-term'             : conf.giscus.term,
                    'data-strict'           : conf.giscus.strict,
                    'data-reactions-enabled': conf.giscus.reactions_enabled,
                    'data-emit-metadata'    : conf.giscus.emit_metadata,
                    'data-theme'            : Diversity.utils.isDarkMode() ? conf.giscus.dark : conf.giscus.theme,
                    'data-lang'             : lang,
                    'data-input-position'   : conf.giscus.input_position,
                    'data-loading'          : conf.giscus.data_loading
                },
                parentNode: document.querySelector('.giscus-wrap')
            }));

        // Giscus加载
        window.addEventListener('message', (e) => {
            if (e.data && e.data.giscus) {
                // 检测到Giscus iframe发送了消息，且数据中存在giscus
                // 则认为Giscus评论已加载，隐藏加载提示
                loadingElement.classList.add('hidden');
            }
        });
    }

    document.addEventListener('page:loaded', loadGiscus);
    document.addEventListener('color-scheme:refresh', loadGiscus);
</script>